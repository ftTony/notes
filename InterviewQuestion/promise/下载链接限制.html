<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同时下载的链接数量不可以超过 3 个</title>
</head>
<body>
    <script>
        var urls = [
            'https://www.kkkk1000.com/images/getImgData/getImgDatadata.jpg', 
            'https://www.kkkk1000.com/images/getImgData/gray.gif', 
            'https://www.kkkk1000.com/images/getImgData/Particle.gif', 
            'https://www.kkkk1000.com/images/getImgData/arithmetic.png', 
            'https://www.kkkk1000.com/images/getImgData/arithmetic2.gif', 
            'https://www.kkkk1000.com/images/getImgData/getImgDataError.jpg', 
            'https://www.kkkk1000.com/images/getImgData/arithmetic.gif', 
            'https://www.kkkk1000.com/images/wxQrCode2.png'
        ];
        function loadImg(url){
            return new Promise((resolve,reject)=>{
                const img = new Image();
                img.onload = function(){
                    console.log('一张图片加载完成功！');
                    resolve();
                };
                img.onerror = reject;
                img.src = url;
                document.documentElement.appendChild(img);
            });
        }

        // var count = 0;
        
        // function request(){
        //     count++;
        //     console.log('并发数：',count);
        //     // 条件判断，urls长度大于0继续，小于等于零说明图片加载完成
        //     // if(urls.length>0 && count <=3){
        //         // shift从数组中取出连接
        //         loadImg(urls.shift()).then(()=>{
        //             // 计数器速减
        //             count--;
        //             // 递归调用
        //         }).then(diaodu);
        //     // }
        // }

        // // 负责高度的函数
        // function diaodu(){
        //     if(urls.length>0 && count<=3){
        //         request();
        //     }
        // }

        // function async1(){
        //     for(var i=0;i<3;i++){
        //         request();
        //     }
        // }
        // async1();

        // 计数器
        // var count = 0;
        // // 全局锁
        // var lock = [];
        // var l = urls.length;
        // // 阻塞函数
        // function block(){
        //     let _resolve;
        //     return new Promise((resolve,reject)=>{
        //         _resolve = resolve;
        //         // resolve不执行，将其推入lock数组
        //         lock.push(_resolve);
        //     })
        // }
        // // 叫号机
        // function next(){
        //     lock.length && lock.shift()()
        // }
        // async function bao(){
        //     if(count>=3){
        //         // 越过限制利用await和promise进行阻塞
        //         await block();
        //     }
        //     if(urls.length>0){
        //         console.log(count);
        //         count++;
        //         await loadImg(urls.shift());
        //         count--;
        //         next();
        //     }
        // }

        // for(let i=0;i<l;i++){
        //     bao();
        // }

        function limitLoad(urls,handler,limit){
            // 对数组做一个拷贝
            const sequence = [].concat(urls);
            let promises = [];

            // 并发请求到最大数
            promises = sequence.splice(0,limit).map((url,index)=>{
                // 这里返回的index是任务在promises的脚本，用于在 Promise.race之后找到完成的任务脚本
                return handler(url).then(()=>{
                    return index;
                });
            });
            (async function loop(){
                let p = Promise.race(promises);
                for(let i =0;i<sequence.length;i++){
                    p = p.then(res=>{
                        promises[res] = handler(sequence[i]).then(() =>{
                            return res
                        });
                        return Promise.race(promises);
                    });
                }
            })();
        }
        limitLoad(urls,loadImg,3);
</script>
</body>
</html>